<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Hospital System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
      /* Page transition animation */
      .view {
        display: none;
        animation: fadeIn 0.3s;
      }
      .view.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Fake QR scanner animation */
      @keyframes scan {
        0% {
          transform: translateY(0px);
          opacity: 0.8;
        }
        100% {
          transform: translateY(256px);
          opacity: 0.8;
        }
      }
      .scanner-line {
        animation: scan 2.5s infinite linear;
      }

      body {
        font-family: "Inter", sans-serif;
      }

      /* Button Styles */
      .bed-action-button,
      .view-patient-button {
        display: none;
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: white;
        border-radius: 0.5rem;
        transition: background-color 0.3s;
        width: 100%;
      }
      @media (min-width: 640px) {
        .bed-action-button,
        .view-patient-button {
          width: auto;
        }
      }

      .view-patient-button {
        background-color: #ef4444;
      }
      .view-patient-button:hover {
        background-color: #dc2626;
      }

      #sidebar-alert-dot {
        display: none;
      }
      #vitals-save-status {
        font-size: 0.875rem;
        margin-top: 0.5rem;
        text-align: center;
      }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100">
    <div id="app">
      <div id="login-view" class="view active">
        <div
          class="flex items-center justify-center min-h-screen bg-gradient-to-r from-[#d1f4e0] to-[#f0fdf4] p-4"
        >
          <div
            class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-xl"
          >
            <div class="flex justify-center">
              <i data-feather="activity" class="w-16 h-16 text-green-600"></i>
            </div>

            <div id="login-form-container">
              <h2 class="text-3xl font-bold text-center text-gray-900">
                Smart Hospital
              </h2>
              <p class="text-center text-gray-500 text-sm mt-2">
                Only accounts created by an Admin can log in.
              </p>

              <div class="space-y-4 mt-6">
                <div>
                  <label
                    for="login-email"
                    class="text-sm font-medium text-gray-700"
                    >Email</label
                  >
                  <input
                    type="email"
                    id="login-email"
                    value="admin@hospital.com"
                    class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-blue-500"
                    placeholder="Enter your email"
                  />
                </div>
                <div>
                  <label
                    for="login-password"
                    class="text-sm font-medium text-gray-700"
                    >Password</label
                  >
                  <input
                    type="password"
                    id="login-password"
                    value="123456"
                    class="w-full px-4 py-2 mt-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Enter your password"
                  />
                </div>
                <div>
                  <label
                    for="login-role-select"
                    class="text-sm font-medium text-gray-700"
                    >Select Your Role</label
                  >
                  <select
                    id="login-role-select"
                    class="w-full px-4 py-2 mt-1 bg-white border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                  ></select>
                </div>
              </div>

              <button
                id="login-button"
                class="w-full py-3 mt-6 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-300"
              >
                Login
              </button>
              <p
                id="login-error"
                class="text-sm text-center text-red-500 mt-2"
              ></p>
            </div>
          </div>
        </div>
      </div>

      <div id="main-app-view" class="view">
        <div class="flex h-screen bg-gray-100 overflow-hidden">
          <aside class="w-64 bg-white shadow-md hidden md:block flex-shrink-0">
            <div class="p-6">
              <div class="flex items-center space-x-2">
                <i data-feather="activity" class="w-10 h-10 text-green-600"></i>
                <span class="text-2xl font-bold text-gray-800"
                  >SmartHospital</span
                >
              </div>
            </div>
            <nav class="mt-6" id="desktop-nav"></nav>
          </aside>

          <div
            id="mobile-menu-overlay"
            class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"
          ></div>
          <div
            id="mobile-menu"
            class="fixed inset-y-0 left-0 w-64 bg-white z-50 transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden overflow-y-auto"
          >
            <div class="p-6 flex justify-between items-center border-b">
              <div class="flex items-center space-x-2">
                <i data-feather="activity" class="w-8 h-8 text-green-600"></i>
                <span class="text-xl font-bold text-gray-800">Menu</span>
              </div>
              <button
                id="close-mobile-menu"
                class="text-gray-600 focus:outline-none"
              >
                <i data-feather="x" class="w-6 h-6"></i>
              </button>
            </div>
            <nav class="mt-4" id="mobile-nav"></nav>
          </div>

          <div class="flex-1 flex flex-col h-screen overflow-hidden">
            <header
              class="flex items-center justify-between p-4 bg-white border-b shadow-sm z-10"
            >
              <div class="flex items-center">
                <button
                  id="open-mobile-menu"
                  class="md:hidden mr-4 text-gray-600 focus:outline-none"
                >
                  <i data-feather="menu" class="w-6 h-6"></i>
                </button>

                <h1
                  id="page-title"
                  class="text-lg md:text-2xl font-semibold text-gray-800 truncate max-w-[200px] md:max-w-none"
                >
                  Bed Management
                </h1>
              </div>

              <div class="flex items-center space-x-2 md:space-x-4">
                <span class="relative">
                  <i
                    data-feather="bell"
                    class="text-gray-600 w-5 h-5 md:w-6 md:h-6"
                    data-role="Nurse,Doctor,Admin"
                  ></i>
                  <span
                    id="header-alert-dot"
                    class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"
                    style="display: none"
                  ></span>
                </span>
                <div class="text-right hidden sm:block">
                  <span
                    id="user-role-display"
                    class="text-sm font-medium text-gray-700 block"
                    >Welcome!</span
                  >
                </div>
                <button
                  id="logout-button"
                  class="text-sm text-blue-600 hover:underline whitespace-nowrap"
                >
                  Logout
                </button>
              </div>
            </header>

            <main class="flex-1 p-4 md:p-6 overflow-auto pb-20">
              <div id="dashboard-view" class="main-view view active">
                <div
                  id="bed-grid-container"
                  class="grid grid-cols-1 gap-4 md:gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
                ></div>
              </div>

              <div id="patient-view" class="main-view view"></div>

              <div id="admin-view" class="main-view view">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
                  Admin Dashboard
                </h2>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                  <div class="p-4 bg-white rounded-lg shadow">
                    <h3 class="text-sm md:text-lg font-semibold text-gray-700">
                      Staff
                    </h3>
                    <p
                      id="admin-stat-staff"
                      class="text-2xl md:text-4xl font-bold text-purple-600"
                    >
                      0
                    </p>
                  </div>
                  <div class="p-4 bg-white rounded-lg shadow">
                    <h3 class="text-sm md:text-lg font-semibold text-gray-700">
                      Patients
                    </h3>
                    <p
                      id="admin-stat-patients"
                      class="text-2xl md:text-4xl font-bold text-blue-600"
                    >
                      0
                    </p>
                  </div>
                  <div class="p-4 bg-white rounded-lg shadow">
                    <h3 class="text-sm md:text-lg font-semibold text-gray-700">
                      Beds
                    </h3>
                    <p
                      id="admin-stat-beds"
                      class="text-2xl md:text-4xl font-bold text-indigo-600"
                    >
                      0
                    </p>
                  </div>
                  <div class="p-4 bg-white rounded-lg shadow">
                    <h3 class="text-sm md:text-lg font-semibold text-gray-700">
                      Occupancy
                    </h3>
                    <p
                      id="admin-stat-occupancy"
                      class="text-2xl md:text-4xl font-bold text-green-600"
                    >
                      0%
                    </p>
                  </div>
                </div>

                <div class="mt-8 grid grid-cols-1 xl:grid-cols-3 gap-6">
                  <div class="xl:col-span-1 space-y-6">
                    <div class="p-4 md:p-6 bg-white rounded-lg shadow">
                      <h3
                        id="user-form-title"
                        class="text-xl font-semibold mb-4"
                      >
                        Create User
                      </h3>
                      <div class="space-y-3">
                        <div>
                          <label class="text-sm text-gray-700">Role</label>
                          <select
                            id="user-form-role"
                            class="w-full px-3 py-2 mt-1 bg-white border rounded-lg"
                          ></select>
                        </div>
                        <div>
                          <label class="text-sm text-gray-700">Email</label>
                          <input
                            type="email"
                            id="user-form-email"
                            class="w-full px-3 py-2 mt-1 border rounded-lg"
                          />
                        </div>
                        <div>
                          <label class="text-sm text-gray-700">Password</label>
                          <input
                            type="password"
                            id="user-form-password"
                            class="w-full px-3 py-2 mt-1 border rounded-lg"
                            placeholder="Optional if editing"
                          />
                        </div>
                        <button
                          id="user-form-save-button"
                          class="w-full mt-4 px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg"
                        >
                          Create User
                        </button>
                        <button
                          id="user-form-cancel-button"
                          class="w-full mt-2 px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hidden"
                        >
                          Cancel
                        </button>
                        <p
                          id="user-form-status"
                          class="text-sm text-center mt-2"
                        ></p>
                      </div>
                    </div>

                    <div class="p-4 md:p-6 bg-white rounded-lg shadow">
                      <h3 class="text-xl font-semibold mb-4">
                        Add New Patient
                      </h3>
                      <div class="space-y-3">
                        <input
                          type="text"
                          id="add-patient-name"
                          class="w-full px-3 py-2 border rounded-lg"
                          placeholder="Name"
                        />
                        <div class="grid grid-cols-2 gap-2">
                          <input
                            type="number"
                            id="add-patient-age"
                            class="w-full px-3 py-2 border rounded-lg"
                            placeholder="Age"
                          />
                          <select
                            id="add-patient-priority"
                            class="w-full px-3 py-2 border rounded-lg"
                          >
                            <option value="NOT SERIOUS">Not Serious</option>
                            <option value="SERIOUS">Serious</option>
                            <option value="EMERGENCY">Emergency</option>
                          </select>
                        </div>
                        <textarea
                          id="add-patient-diagnosis"
                          class="w-full px-3 py-2 border rounded-lg"
                          rows="2"
                          placeholder="Diagnosis"
                        ></textarea>
                        <textarea
                          id="add-patient-meds"
                          class="w-full px-3 py-2 border rounded-lg"
                          rows="2"
                          placeholder="Meds"
                        ></textarea>
                        <select
                          id="add-patient-bed"
                          class="w-full px-3 py-2 border rounded-lg"
                        ></select>
                        <button
                          id="add-patient-button"
                          class="w-full mt-2 py-3 font-semibold text-white bg-green-600 rounded-lg"
                        >
                          Add Patient
                        </button>
                        <p
                          id="add-patient-status"
                          class="text-sm text-center mt-2"
                        ></p>
                      </div>
                    </div>
                  </div>

                  <div class="xl:col-span-2 space-y-6">
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                      <h3 class="text-xl font-semibold p-4 md:p-6">
                        Staff Management
                      </h3>
                      <div class="overflow-x-auto">
                        <table class="w-full min-w-max">
                          <thead class="bg-gray-50">
                            <tr>
                              <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                              >
                                Email
                              </th>
                              <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                              >
                                Role
                              </th>
                              <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                              >
                                Actions
                              </th>
                            </tr>
                          </thead>
                          <tbody
                            id="admin-staff-table"
                            class="divide-y divide-gray-200"
                          ></tbody>
                        </table>
                      </div>
                    </div>

                    <div class="bg-white rounded-lg shadow overflow-hidden">
                      <h3 class="text-xl font-semibold p-4 md:p-6">
                        Patient Management
                      </h3>
                      <div class="overflow-x-auto">
                        <table class="w-full min-w-max">
                          <thead class="bg-gray-50">
                            <tr>
                              <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                              >
                                Name
                              </th>
                              <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                              >
                                Bed
                              </th>
                              <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                              >
                                Priority
                              </th>
                              <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                              >
                                Action
                              </th>
                            </tr>
                          </thead>
                          <tbody
                            id="admin-patient-table"
                            class="divide-y divide-gray-200"
                          ></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div id="tasks-view" class="main-view view">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
                  All Patient Tasks
                </h2>
                <div
                  id="nurse-task-list-container"
                  class="p-4 md:p-6 bg-white rounded-lg shadow space-y-4"
                ></div>
              </div>

              <div id="cleaning-view" class="main-view view">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
                  Cleaning & Maintenance
                </h2>
                <div
                  id="cleaning-task-list-container"
                  class="p-4 md:p-6 bg-white rounded-lg shadow max-w-2xl mx-auto"
                ></div>
              </div>

              <div id="alerts-view" class="main-view view">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
                  Active Alerts
                </h2>
                <div
                  id="alert-list-container"
                  class="p-4 md:p-6 bg-white rounded-lg shadow space-y-4 max-w-4xl mx-auto"
                ></div>
              </div>

              <div id="qr-scan-view" class="main-view view">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">
                  Scan Patient QR
                </h2>
                <div class="p-6 bg-white rounded-lg shadow max-w-lg mx-auto">
                  <p class="text-center text-gray-600 mb-4">
                    Hold the patient's QR code up to the camera.
                  </p>
                  <div
                    class="w-full h-64 bg-gray-900 rounded-lg flex items-center justify-center overflow-hidden relative"
                  >
                    <i
                      data-feather="maximize"
                      class="w-32 h-32 text-gray-700"
                    ></i>
                    <div
                      class="absolute top-0 w-full h-1 bg-green-400 shadow-lg scanner-line"
                    ></div>
                  </div>
                  <button
                    id="simulate-scan-button"
                    class="w-full mt-6 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-300"
                  >
                    Simulate Scan (Patient p1)
                  </button>
                </div>
              </div>
            </main>
          </div>
        </div>
      </div>
    </div>

    <div
      id="admit-patient-modal"
      class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white rounded-lg p-6 md:p-8 shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto"
      >
        <h2
          id="admit-modal-title"
          class="text-xl md:text-2xl font-bold text-gray-900 mb-6"
        >
          Admit Patient
        </h2>
        <div class="space-y-4">
          <input
            type="text"
            id="admit-patient-name"
            class="w-full px-4 py-2 border rounded-lg"
            placeholder="Patient Name*"
          />
          <div class="grid grid-cols-2 gap-4">
            <input
              type="number"
              id="admit-patient-age"
              class="w-full px-4 py-2 border rounded-lg"
              placeholder="Age*"
            />
            <select
              id="admit-patient-priority"
              class="w-full px-4 py-2 bg-white border rounded-lg"
            >
              <option value="NOT SERIOUS">NOT SERIOUS</option>
              <option value="SERIOUS">SERIOUS</option>
              <option value="EMERGENCY">EMERGENCY</option>
            </select>
          </div>
          <textarea
            id="admit-patient-diagnosis"
            class="w-full px-4 py-2 border rounded-lg"
            rows="2"
            placeholder="Initial Diagnosis"
          ></textarea>
          <textarea
            id="admit-patient-meds"
            class="w-full px-4 py-2 border rounded-lg"
            rows="2"
            placeholder="Medications"
          ></textarea>
        </div>
        <div class="flex justify-end space-x-4 mt-6">
          <button
            id="admit-modal-cancel"
            class="px-6 py-2 font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300"
          >
            Cancel
          </button>
          <button
            id="admit-modal-save"
            class="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700"
          >
            Admit
          </button>
        </div>
      </div>
    </div>

    <script>
      // --- "FAKE" DATABASES ---
      let userDatabase = [
        { email: "admin@hospital.com", password: "123456", role: "Admin" },
      ];
      let appState = {
        patients: {
          p1: {
            id: "p1",
            name: "John Doe",
            bedId: "bed101",
            age: 45,
            diagnosis: "Cardiac Arrest",
            medications: "Aspirin, Beta-blockers",
            priority: "EMERGENCY",
            vitalsLog: [
              {
                time: "Today 08:00 AM",
                bp: "120/80",
                pulse: "78",
                notes: "Stable.",
              },
            ],
          },
          p2: {
            id: "p2",
            name: "Jane Smith",
            bedId: "bed102",
            age: 62,
            diagnosis: "Pneumonia",
            medications: "Antibiotics",
            priority: "SERIOUS",
            vitalsLog: [
              {
                time: "Today 09:15 AM",
                bp: "130/85",
                pulse: "92",
                notes: "Slight fever.",
              },
            ],
          },
        },
        beds: [
          {
            id: "bed101",
            title: "Bed 101 - ICU",
            status: "OCCUPIED",
            patientId: "p1",
          },
          {
            id: "bed102",
            title: "Bed 102 - Ward A",
            status: "OCCUPIED",
            patientId: "p2",
          },
          {
            id: "bed103",
            title: "Bed 103 - Ward A",
            status: "AVAILABLE",
            patientId: null,
          },
          {
            id: "bed104",
            title: "Bed 104 - Ward B",
            status: "PENDING_CLEANING",
            patientId: null,
          },
          {
            id: "bed105",
            title: "Bed 105 - Ward C",
            status: "PENDING_CLEANING",
            patientId: null,
          },
          {
            id: "bed106",
            title: "Bed 106 - Ward C",
            status: "PENDING_CLEANING",
            patientId: null,
          },
          {
            id: "bed107",
            title: "Bed 107 - Ward D",
            status: "PENDING_CLEANING",
            patientId: null,
          },
          {
            id: "bed108",
            title: "Bed 108 - Ward D",
            status: "PENDING_CLEANING",
            patientId: null,
          },
          {
            id: "bed109",
            title: "Bed 109 - Ward E",
            status: "PENDING_CLEANING",
            patientId: null,
          },
          {
            id: "bed110",
            title: "Bed 110 - OP",
            status: "PENDING_CLEANING",
            patientId: null,
          },
          {
            id: "bed111",
            title: "Bed 111 - ICU",
            status: "PENDING_CLEANING",
            patientId: null,
          },
        ],
        nurseTasks: [
          {
            id: "nt1",
            patientId: "p1",
            text: "Check vitals (10:00 AM)",
            status: "PENDING",
          },
          {
            id: "nt2",
            patientId: "p1",
            text: "Notify Doctor of BP drop",
            status: "PENDING",
            isUrgent: true,
          },
          {
            id: "nt3",
            patientId: "p1",
            text: "Administer 8:00 AM medication",
            status: "COMPLETED",
          },
          {
            id: "nt4",
            patientId: "p2",
            text: "Check vitals (10:00 AM)",
            status: "PENDING",
          },
        ],
        alerts: [
          {
            id: "a1",
            patientId: "p1",
            title: "EMERGENCY: Bed 101 - Vitals Critical",
            text: "Patient John Doe's heart rate dropped to 45 BPM.",
            level: "emergency",
          },
          {
            id: "a2",
            patientId: "p2",
            title: "WARNING: Bed 102 - Medication Due",
            text: "Patient Jane Smith's 10:00 AM medication is 30 minutes overdue.",
            level: "warning",
          },
        ],
      };
      const ALL_ROLES = ["Admin", "Doctor", "Nurse", "Cleaner", "Ambulance"];

      // --- 1. Run feather icons ---
      feather.replace();

      // --- 2. Get all elements ---
      const loginView = document.getElementById("login-view"),
        mainAppView = document.getElementById("main-app-view"),
        loginFormContainer = document.getElementById("login-form-container"),
        loginButton = document.getElementById("login-button"),
        loginError = document.getElementById("login-error"),
        loginRoleSelect = document.getElementById("login-role-select"),
        logoutButton = document.getElementById("logout-button"),
        userRoleDisplay = document.getElementById("user-role-display"),
        pageTitle = document.getElementById("page-title"),
        mainViews = document.querySelectorAll(".main-view"),
        simulateScanButton = document.getElementById("simulate-scan-button"),
        bedGridContainer = document.getElementById("bed-grid-container"),
        patientViewContainer = document.getElementById("patient-view"),
        nurseTaskContainer = document.getElementById(
          "nurse-task-list-container"
        ),
        cleaningTaskContainer = document.getElementById(
          "cleaning-task-list-container"
        ),
        alertListContainer = document.getElementById("alert-list-container"),
        sidebarAlertDot = document.getElementById("sidebar-alert-dot"),
        headerAlertDot = document.getElementById("header-alert-dot"),
        userFormTitle = document.getElementById("user-form-title"),
        userFormSaveButton = document.getElementById("user-form-save-button"),
        userFormCancelButton = document.getElementById(
          "user-form-cancel-button"
        ),
        userFormStatus = document.getElementById("user-form-status"),
        userFormEmail = document.getElementById("user-form-email"),
        userFormPassword = document.getElementById("user-form-password"),
        userFormRole = document.getElementById("user-form-role"),
        adminStatStaff = document.getElementById("admin-stat-staff"),
        adminStatPatients = document.getElementById("admin-stat-patients"),
        adminStatBeds = document.getElementById("admin-stat-beds"),
        adminStatOccupancy = document.getElementById("admin-stat-occupancy"),
        adminStaffTable = document.getElementById("admin-staff-table"),
        adminPatientTable = document.getElementById("admin-patient-table"),
        admitPatientModal = document.getElementById("admit-patient-modal"),
        admitModalTitle = document.getElementById("admit-modal-title"),
        admitModalCancel = document.getElementById("admit-modal-cancel"),
        admitModalSave = document.getElementById("admit-modal-save"),
        addPatientButton = document.getElementById("add-patient-button"),
        addPatientStatus = document.getElementById("add-patient-status"),
        addPatientBedSelect = document.getElementById("add-patient-bed");

      // MOBILE ELEMENTS
      const mobileMenuBtn = document.getElementById("open-mobile-menu"),
        closeMobileMenuBtn = document.getElementById("close-mobile-menu"),
        mobileMenu = document.getElementById("mobile-menu"),
        mobileMenuOverlay = document.getElementById("mobile-menu-overlay"),
        desktopNav = document.getElementById("desktop-nav"),
        mobileNav = document.getElementById("mobile-nav");

      let currentUserRole = null,
        currentPatientId = null,
        currentBedToAdmit = null;

      // --- 3. Mobile Menu Logic ---
      function toggleMobileMenu() {
        const isHidden = mobileMenu.classList.contains("-translate-x-full");
        if (isHidden) {
          mobileMenu.classList.remove("-translate-x-full");
          mobileMenuOverlay.classList.remove("hidden");
        } else {
          mobileMenu.classList.add("-translate-x-full");
          mobileMenuOverlay.classList.add("hidden");
        }
      }
      mobileMenuBtn.addEventListener("click", toggleMobileMenu);
      closeMobileMenuBtn.addEventListener("click", toggleMobileMenu);
      mobileMenuOverlay.addEventListener("click", toggleMobileMenu);

      // --- 4. Define Navigation Links Data ---
      const navLinksData = [
        {
          text: "Bed Management",
          icon: "layout",
          view: "dashboard-view",
          roles: "Nurse,Doctor,Admin,Ambulance",
        },
        {
          text: "Alerts",
          icon: "bell",
          view: "alerts-view",
          roles: "Nurse,Doctor,Admin",
          hasDot: true,
        },
        {
          text: "Scan QR",
          icon: "maximize",
          view: "qr-scan-view",
          roles: "Nurse,Doctor",
        },
        {
          text: "All Patient Tasks",
          icon: "check-square",
          view: "tasks-view",
          roles: "Nurse",
        },
        {
          text: "Cleaning",
          icon: "trash-2",
          view: "cleaning-view",
          roles: "Cleaner,Admin",
        },
        {
          text: "Admin Panel",
          icon: "settings",
          view: "admin-view",
          roles: "Admin", // STRICTLY Admin only
        },
      ];

      function renderNavigation() {
        // FILTER: Only show links allowed for the current user
        const visibleLinks = navLinksData.filter((link) => {
          const allowedRoles = link.roles.split(",");
          return allowedRoles.includes(currentUserRole);
        });

        const generateLink = (link) => {
          return `
            <a class="nav-link flex items-center px-6 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600" 
               href="#" data-view="${link.view}" data-role="${link.roles}">
               <i data-feather="${link.icon}"></i>
               <span class="ml-3">${link.text}</span>
               ${
                 link.hasDot
                   ? '<span id="alert-dot-' +
                     link.view +
                     '" class="ml-auto w-2 h-2 bg-red-500 rounded-full hidden"></span>'
                   : ""
               }
            </a>`;
        };

        const linksHtml = visibleLinks.map(generateLink).join("");
        desktopNav.innerHTML = linksHtml;
        mobileNav.innerHTML = linksHtml;

        // Re-run feather to render icons in new HTML
        feather.replace();

        // Re-attach event listeners to ALL nav links (desktop + mobile)
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            // Close mobile menu if open
            mobileMenu.classList.add("-translate-x-full");
            mobileMenuOverlay.classList.add("hidden");

            const viewId = link.getAttribute("data-view");
            if (viewId) {
              showView(viewId, true);
              pageTitle.textContent = link.querySelector("span").textContent;
              if (viewId === "tasks-view") renderNurseTasksView();
              if (viewId === "cleaning-view") renderCleaningView();
              if (viewId === "alerts-view") renderAlertsView();
              if (viewId === "admin-view") renderAdminView();
              if (viewId === "dashboard-view") renderBedDashboard();
            }
          });
        });
      }

      // --- 5. View & UI Logic ---
      function showView(viewId, isSubView = false) {
        if (isSubView) {
          mainViews.forEach((v) => v.classList.remove("active"));
          const vt = document.getElementById(viewId);
          if (vt) vt.classList.add("active");
        } else {
          document
            .querySelectorAll(".view")
            .forEach((v) => v.classList.remove("active"));
          const vt = document.getElementById(viewId);
          if (vt) vt.classList.add("active");
        }
      }

      function getBedStatusStyles(status, patientPriority = null) {
        if (status === "OCCUPIED") {
          switch (patientPriority) {
            case "EMERGENCY":
              return {
                bg: "bg-red-100",
                border: "border-red-500",
                text: "text-red-800",
                statusText: "text-red-600",
              };
            case "SERIOUS":
              return {
                bg: "bg-yellow-100",
                border: "border-yellow-500",
                text: "text-yellow-800",
                statusText: "text-yellow-600",
              };
            case "NOT SERIOUS":
              return {
                bg: "bg-indigo-100",
                border: "border-indigo-500",
                text: "text-indigo-800",
                statusText: "text-indigo-600",
              };
            default:
              return {
                bg: "bg-gray-100",
                border: "border-gray-500",
                text: "text-gray-800",
                statusText: "text-gray-600",
              };
          }
        }
        switch (status) {
          case "AVAILABLE":
            return {
              bg: "bg-green-100",
              border: "border-green-500",
              text: "text-green-800",
              statusText: "text-green-600",
            };
          case "PENDING_CLEANING":
            return {
              bg: "bg-yellow-100",
              border: "border-yellow-500",
              text: "text-yellow-800",
              statusText: "text-yellow-600",
            };
          case "UNDER_CLEANING":
            return {
              bg: "bg-blue-100",
              border: "border-blue-500",
              text: "text-blue-800",
              statusText: "text-blue-600",
            };
          default:
            return {
              bg: "bg-gray-100",
              border: "border-gray-500",
              text: "text-gray-800",
              statusText: "text-gray-600",
            };
        }
      }

      function renderBedDashboard() {
        bedGridContainer.innerHTML = "";
        const isAmbulance = currentUserRole === "Ambulance";
        appState.beds.forEach((bed) => {
          const patient = bed.patientId
            ? appState.patients[bed.patientId]
            : null;
          const priority = patient ? patient.priority : null;
          const styles = getBedStatusStyles(bed.status, priority);
          let patientName = "&nbsp;";
          // AMBULANCE RESTRICTION: Do not show patient name
          if (patient && !isAmbulance) patientName = `Patient: ${patient.name}`;
          let statusText = bed.status.replace("_", " ");
          if (bed.status === "OCCUPIED" && priority) statusText = priority;

          let buttonsHTML = "";
          // AMBULANCE RESTRICTION: Do not show Action Buttons
          if (!isAmbulance) {
            if (bed.status === "OCCUPIED") {
              buttonsHTML += `<button class="view-patient-button w-full" data-patient-id="${bed.patientId}" data-role="Nurse,Doctor,Admin">View Patient</button>`;
              buttonsHTML += `<button class="bed-action-button w-full bg-yellow-500 hover:bg-yellow-600" data-action="Discharge" data-bed-id="${bed.id}" data-role="Doctor,Admin">Discharge</button>`;
            }
            if (bed.status === "AVAILABLE") {
              buttonsHTML += `<button class="bed-action-button w-full bg-green-500 hover:bg-green-600" data-action="Admit" data-bed-id="${bed.id}" data-role="Doctor,Admin">Admit</button>`;
            }
          }
          bedGridContainer.innerHTML += `<div class="p-6 ${styles.bg} border-l-4 ${styles.border} rounded-lg shadow"><h3 class="text-lg font-semibold ${styles.text}">${bed.title}</h3><p class="font-bold ${styles.statusText}">Status: ${statusText}</p><p class="text-gray-700 truncate">${patientName}</p>${buttonsHTML}</div>`;
        });
        applyRoleVisibility();
      }

      function renderPatientView(patientId) {
        currentPatientId = patientId;
        const patient = appState.patients[patientId];
        if (!patient) return;
        const isAdminEditing = currentUserRole === "Admin";
        let pendingTasksHTML = "",
          completedTasksHTML = "",
          vitalsHistoryHTML = "";

        appState.nurseTasks
          .filter((t) => t.patientId === patientId)
          .forEach((task) => {
            const isUrgent = task.isUrgent || false;
            const taskHTML = `<label class="flex items-center p-3 ${
              task.status === "PENDING"
                ? isUrgent
                  ? "bg-red-50"
                  : "bg-gray-50"
                : "bg-green-50"
            } rounded-lg hover:bg-gray-100 cursor-pointer"><input type="checkbox" class="task-checkbox w-5 h-5 ${
              isUrgent
                ? "text-red-600"
                : task.status === "PENDING"
                ? "text-blue-600"
                : "text-green-600"
            } rounded" data-task-id="${task.id}" ${
              task.status === "COMPLETED" ? "checked" : ""
            } data-role="Nurse,Doctor,Admin"/><span class="ml-3 ${
              task.status === "PENDING"
                ? isUrgent
                  ? "font-medium text-red-800"
                  : "text-gray-800"
                : "text-gray-500 line-through"
            }">${task.text}</span></label>`;
            if (task.status === "PENDING") pendingTasksHTML += taskHTML;
            else completedTasksHTML += taskHTML;
          });

        patient.vitalsLog
          .slice()
          .reverse()
          .forEach((log) => {
            vitalsHistoryHTML += `<li class="border-b pb-2 mb-2"><p class="text-sm font-medium text-gray-800">BP: ${log.bp}, Pulse: ${log.pulse}</p><p class="text-sm text-gray-600">${log.notes}</p><p class="text-xs text-gray-400 text-right">${log.time}</p></li>`;
          });

        const priorities = ["NOT SERIOUS", "SERIOUS", "EMERGENCY"];
        let priorityOptionsHTML = priorities
          .map(
            (p) =>
              `<option value="${p}" ${
                patient.priority === p ? "selected" : ""
              }>${p}</option>`
          )
          .join("");

        let patientInfoHTML = isAdminEditing
          ? `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="text-sm font-medium text-gray-700">Name</label><input type="text" id="patient-edit-name" class="w-full px-3 py-2 mt-1 border rounded-lg" value="${patient.name}" /></div><div><label class="text-sm font-medium text-gray-700">Age</label><input type="number" id="patient-edit-age" class="w-full px-3 py-2 mt-1 border rounded-lg" value="${patient.age}" /></div><div class="md:col-span-2"><label class="text-sm font-medium text-gray-700">Diagnosis</label><textarea id="patient-edit-diagnosis" class="w-full px-3 py-2 mt-1 border rounded-lg" rows="2">${patient.diagnosis}</textarea></div><div class="md:col-span-2"><label class="text-sm font-medium text-gray-700">Medications</label><textarea id="patient-edit-meds" class="w-full px-3 py-2 mt-1 border rounded-lg" rows="2">${patient.medications}</textarea></div></div><button id="save-patient-changes-button" class="mt-4 w-full px-6 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700" data-role="Admin">Save Changes</button>`
          : `<div class="grid grid-cols-1 md:grid-cols-2 gap-4"><p><strong class="text-gray-600">Age:</strong> ${patient.age}</p><p><strong class="text-gray-600">Diagnosis:</strong> ${patient.diagnosis}</p><p class="md:col-span-2"><strong class="text-gray-600">Meds:</strong> ${patient.medications}</p></div>`;

        const patientHTML = `<button class="back-to-dashboard text-blue-600 hover:underline mb-4">&larr; Back to Dashboard</button><h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6">Patient: ${
          patient.name
        }</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div class="p-6 bg-white rounded-lg shadow"><h3 class="text-xl font-semibold mb-4">Information</h3>${patientInfoHTML}<div class="mt-4 pt-4 border-t" data-role="Doctor,Admin"><label class="text-sm font-medium text-gray-700">Priority:</label><div class="flex space-x-2 mt-1"><select id="patient-priority-select" class="w-full px-3 py-2 bg-white border rounded-lg">${priorityOptionsHTML}</select><button id="save-priority-button" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Set</button></div></div></div><div class="p-6 bg-white rounded-lg shadow" data-role="Nurse,Doctor"><h3 class="text-xl font-semibold mb-4">Log Vitals</h3><div class="grid grid-cols-2 gap-4"><div><label class="text-sm font-medium text-gray-700">BP</label><input type="text" id="vitals-bp" class="w-full px-3 py-2 mt-1 border rounded-lg" placeholder="120/80" /></div><div><label class="text-sm font-medium text-gray-700">Pulse</label><input type="text" id="vitals-pulse" class="w-full px-3 py-2 mt-1 border rounded-lg" placeholder="80" /></div><div class="col-span-2"><label class="text-sm font-medium text-gray-700">Notes</label><textarea id="vitals-notes" class="w-full px-3 py-2 mt-1 border rounded-lg" rows="3"></textarea></div></div><button id="save-vitals-button" class="w-full mt-4 px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save Vitals</button><p id="vitals-save-status" class="text-green-600"></p></div><div class="p-6 bg-white rounded-lg shadow" data-role="Nurse,Doctor,Admin"><h3 class="text-xl font-semibold mb-4">Vitals History</h3><ul class="max-h-60 overflow-y-auto">${
          vitalsHistoryHTML || "<p>No vitals logged yet.</p>"
        }</ul></div></div><div id="patient-task-checklist" class="p-6 bg-white rounded-lg shadow space-y-4"><h3 class="text-xl font-semibold">Tasks</h3><div class="flex space-x-2" data-role="Doctor,Admin"><input type="text" id="new-task-input" class="w-full px-3 py-2 border rounded-lg" placeholder="New task..." /><button id="add-task-button" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Add</button></div><div id="pending-tasks-list" class="space-y-2 pt-4"><h4 class="text-lg font-semibold text-gray-800">Pending</h4>${
          pendingTasksHTML || "<p class='text-sm text-gray-500'>None</p>"
        }</div><div id="completed-tasks-list" class="space-y-2 pt-4"><h4 class="text-lg font-semibold text-gray-800">Completed</h4>${
          completedTasksHTML || "<p class='text-sm text-gray-500'>None</p>"
        }</div></div></div>`;
        patientViewContainer.innerHTML = patientHTML;
        applyRoleVisibility();
      }

      function renderNurseTasksView() {
        let pendingTasksHTML = "",
          completedTasksHTML = "";
        appState.nurseTasks.forEach((task) => {
          const patient = appState.patients[task.patientId];
          if (!patient) return;
          const taskLabel = `(${patient.name}, Bed ${patient.bedId.replace(
            "bed",
            ""
          )})`;
          const isUrgent = task.isUrgent || false;
          const taskHTML = `<label class="flex items-center p-3 ${
            task.status === "PENDING"
              ? isUrgent
                ? "bg-red-50"
                : "bg-gray-50"
              : "bg-green-50"
          } rounded-lg"><input type="checkbox" class="w-5 h-5 ${
            isUrgent
              ? "text-red-600"
              : task.status === "PENDING"
              ? "text-blue-600"
              : "text-green-600"
          } rounded" disabled /><span class="ml-3 ${
            task.status === "PENDING"
              ? isUrgent
                ? "font-medium text-red-800"
                : "text-gray-800"
              : "text-gray-500 line-through"
          }">${task.text} ${taskLabel}</span></label>`;
          if (task.status === "PENDING") pendingTasksHTML += taskHTML;
          else completedTasksHTML += taskHTML;
        });
        nurseTaskContainer.innerHTML = `<h3 class="text-xl font-semibold">Pending Tasks</h3><div class="space-y-2 mt-2">${
          pendingTasksHTML ||
          "<p class='text-sm text-gray-500'>No pending tasks.</p>"
        }</div><h3 class="text-xl font-semibold pt-4 mt-4 border-t">Completed Tasks</h3><div class="space-y-2 mt-2">${
          completedTasksHTML ||
          "<p class='text-sm text-gray-500'>No completed tasks.</p>"
        }</div>`;
      }

      function renderCleaningView() {
        let pendingTasksHTML = "",
          inProgressTasksHTML = "";
        const cleaningBeds = appState.beds.filter(
          (bed) =>
            bed.status === "PENDING_CLEANING" || bed.status === "UNDER_CLEANING"
        );
        if (cleaningBeds.length === 0) {
          cleaningTaskContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">No rooms need cleaning.</h3>`;
          return;
        }
        cleaningBeds.forEach((bed) => {
          if (bed.status === "PENDING_CLEANING")
            pendingTasksHTML += `<div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-yellow-100 rounded-lg gap-2"><span class="font-medium text-yellow-800">${bed.title} needs cleaning.</span><button class="bed-action-button bg-blue-500 hover:bg-blue-600" data-role="Cleaner,Admin" data-action="Start-Cleaning" data-bed-id="${bed.id}">Start Cleaning</button></div>`;
          else if (bed.status === "UNDER_CLEANING")
            inProgressTasksHTML += `<div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 bg-blue-100 rounded-lg gap-2"><span class="font-medium text-blue-800">${bed.title} in progress.</span><button class="bed-action-button bg-green-500 hover:bg-green-600" data-role="Cleaner,Admin" data-action="Mark-Clean" data-bed-id="${bed.id}">Mark as Clean</button></div>`;
        });
        cleaningTaskContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">Pending</h3><div class="space-y-3">${
          pendingTasksHTML || '<p class="text-gray-500">None.</p>'
        }</div><h3 class="text-xl font-semibold mt-6 mb-4">In Progress</h3><div class="space-y-3">${
          inProgressTasksHTML || '<p class="text-gray-500">None.</p>'
        }</div>`;
        applyRoleVisibility();
      }

      function renderAlertsView() {
        if (appState.alerts.length === 0) {
          alertListContainer.innerHTML = `<h3 class="text-xl font-semibold mb-4">No Active Alerts.</h3>`;
          if (sidebarAlertDot) sidebarAlertDot.style.display = "none";
          headerAlertDot.style.display = "none";
          // Hide dots in mobile/desktop navs
          document
            .querySelectorAll('[id^="alert-dot-"]')
            .forEach((el) => el.classList.add("hidden"));
          return;
        }

        let alertsHTML = "";
        appState.alerts.forEach((alert) => {
          let alertStyles, icon, alertPriorityText;
          switch (alert.level) {
            case "emergency":
              alertStyles = {
                bg: "bg-red-100",
                border: "border-red-500",
                text: "text-red-800",
                iconColor: "text-red-600",
              };
              icon = "alert-triangle";
              alertPriorityText = "EMERGENCY";
              break;
            case "warning":
              alertStyles = {
                bg: "bg-yellow-100",
                border: "border-yellow-500",
                text: "text-yellow-800",
                iconColor: "text-yellow-600",
              };
              icon = "alert-circle";
              alertPriorityText = "URGENT";
              break;
            case "info":
              alertStyles = {
                bg: "bg-blue-100",
                border: "border-blue-500",
                text: "text-blue-800",
                iconColor: "text-blue-600",
              };
              icon = "info";
              alertPriorityText = "INFO";
              break;
            default:
              alertStyles = {
                bg: "bg-gray-100",
                border: "border-gray-500",
                text: "text-gray-800",
                iconColor: "text-gray-600",
              };
              icon = "help-circle";
              alertPriorityText = "UNKNOWN";
          }

          const priorityDropdownHTML = `<div class="mt-4" data-role="Doctor,Admin"><label class="text-sm font-medium ${
            alertStyles.text
          }">Update Status:</label><select class="update-alert-priority w-full mt-1 p-2 border ${
            alertStyles.border
          } ${alertStyles.bg} ${alertStyles.text} rounded-lg" data-alert-id="${
            alert.id
          }"><option value="emergency" ${
            alert.level === "emergency" ? "selected" : ""
          }>EMERGENCY</option><option value="warning" ${
            alert.level === "warning" ? "selected" : ""
          }>Urgent</option><option value="info" ${
            alert.level === "info" ? "selected" : ""
          }>Info</option></select></div>`;

          alertsHTML += `<div class="flex flex-col sm:flex-row items-start p-4 ${
            alertStyles.bg
          } ${
            alertStyles.border
          } border-l-4 rounded-lg gap-4"><div class="flex-1 flex items-start"><i data-feather="${icon}" class="w-6 h-6 ${
            alertStyles.iconColor
          } mr-4 flex-shrink-0 mt-1"></i><div class="w-full"><h3 class="text-lg font-semibold ${
            alertStyles.text
          }">${alert.title}</h3><p class="${alertStyles.text.replace(
            "800",
            "700"
          )}">${
            alert.text
          }</p><button class="view-patient-button" data-patient-id="${
            alert.patientId
          }" data-role="Nurse,Doctor,Admin">View Patient</button>${priorityDropdownHTML}</div></div><button class="resolve-alert-button p-2 text-gray-500 hover:text-green-600 self-end sm:self-start" data-alert-id="${
            alert.id
          }" data-role="Nurse,Doctor,Admin" title="Resolve Alert"><i data-feather="check-circle" class="w-6 h-6"></i></button></div>`;
        });

        alertListContainer.innerHTML = alertsHTML;
        headerAlertDot.style.display = "block";
        // Show dots in navs
        document
          .querySelectorAll('[id^="alert-dot-alerts-view"]')
          .forEach((el) => el.classList.remove("hidden"));
        feather.replace();
        applyRoleVisibility();
      }

      function renderAdminView() {
        const staffCount = userDatabase.length;
        const patientCount = Object.keys(appState.patients).length;
        const bedCount = appState.beds.length;
        const occupiedBeds = appState.beds.filter(
          (b) => b.status === "OCCUPIED"
        ).length;
        const occupancy =
          bedCount > 0 ? Math.round((occupiedBeds / bedCount) * 100) : 0;

        adminStatStaff.textContent = staffCount;
        adminStatPatients.textContent = patientCount;
        adminStatBeds.textContent = bedCount;
        adminStatOccupancy.textContent = `${occupancy}%`;

        adminStaffTable.innerHTML = "";
        userDatabase.forEach((user) => {
          const isAdmin = user.role === "Admin";
          adminStaffTable.innerHTML += `<tr><td class="px-6 py-4 whitespace-nowrap">${
            user.email
          }</td><td class="px-6 py-4 whitespace-nowrap">${
            user.role
          }</td><td class="px-6 py-4 whitespace-nowrap space-x-2"><button class="edit-user-button text-blue-600 hover:underline" data-email="${
            user.email
          }" ${
            isAdmin ? "disabled" : ""
          }>Edit</button><button class="remove-user-button text-red-600 hover:underline" data-email="${
            user.email
          }" ${isAdmin ? "disabled" : ""}>Del</button></td></tr>`;
        });

        adminPatientTable.innerHTML = "";
        Object.values(appState.patients).forEach((patient) => {
          adminPatientTable.innerHTML += `<tr><td class="px-6 py-4 whitespace-nowrap">${
            patient.name
          }</td><td class="px-6 py-4 whitespace-nowrap">${patient.bedId.replace(
            "bed",
            "Bed "
          )}</td><td class="px-6 py-4 whitespace-nowrap">${
            patient.priority
          }</td><td class="px-6 py-4 whitespace-nowrap"><button class="view-patient-button w-auto" data-patient-id="${
            patient.id
          }" data-role="Admin" style="display:inline-block; margin:0; padding: 0.25rem 0.5rem;">View</button></td></tr>`;
        });

        const availableBeds = appState.beds.filter(
          (b) => b.status === "AVAILABLE"
        );
        addPatientBedSelect.innerHTML = availableBeds
          .map((b) => `<option value="${b.id}">${b.title}</option>`)
          .join("");
        if (availableBeds.length === 0) {
          addPatientBedSelect.innerHTML =
            '<option value="" disabled>No available beds</option>';
          addPatientButton.disabled = true;
        } else {
          addPatientButton.disabled = false;
        }
        applyRoleVisibility();
      }

      function renderAll() {
        renderBedDashboard();
        renderNurseTasksView();
        renderCleaningView();
        renderAlertsView();
        if (currentUserRole === "Admin") renderAdminView();
      }

      function populateRoleDropdowns() {
        const rolesHTML = ALL_ROLES.map(
          (r) =>
            `<option value="${r}">${r.replace(
              "Ambulance",
              "Ambulance Driver"
            )}</option>`
        ).join("");
        loginRoleSelect.innerHTML = rolesHTML;
        userFormRole.innerHTML = rolesHTML;
        loginRoleSelect.value = "Admin";
      }

      function resetUserForm() {
        userFormTitle.textContent = "Create New User";
        userFormSaveButton.textContent = "Create User";
        userFormCancelButton.classList.add("hidden");
        userFormEmail.value = "";
        userFormPassword.value = "";
        userFormStatus.textContent = "";
        userFormEmail.readOnly = false;
        userFormEmail.classList.remove("bg-gray-100");
      }

      function setupUIForRole(role) {
        currentUserRole = role;
        userRoleDisplay.textContent = `Welcome, ${role.replace(
          "Ambulance",
          "Driver"
        )}!`;
        renderNavigation(); // Renders desktop and mobile navs
        applyRoleVisibility(); // Apply visibility based on role
        renderAll();

        let defaultView = "dashboard-view";
        let defaultTitle = "Bed Management";
        if (role === "Admin") {
          defaultView = "admin-view";
          defaultTitle = "Admin Dashboard";
          renderAdminView();
        } else if (role === "Cleaner") {
          defaultView = "cleaning-view";
          defaultTitle = "Cleaning";
        }

        showView(defaultView, true);
        pageTitle.textContent = defaultTitle;
      }

      function applyRoleVisibility() {
        document.querySelectorAll("[data-role]").forEach((el) => {
          const roles = el.dataset.role || "";
          // For elements that are NOT nav links (buttons, divs, etc)
          if (!el.classList.contains("nav-link")) {
            if (currentUserRole === "Ambulance") {
              el.style.display = roles.includes("Ambulance") ? "block" : "none";
            } else if (
              roles.includes(currentUserRole) ||
              currentUserRole === "Admin"
            ) {
              el.style.display = "block";
            } else {
              el.style.display = "none";
            }
          }
        });
      }

      // --- 6. Event Listeners ---
      loginButton.addEventListener("click", () => {
        const email = document.getElementById("login-email").value,
          password = document.getElementById("login-password").value,
          role = loginRoleSelect.value;
        loginError.textContent = "";
        let foundUser = userDatabase.find((user) => user.email === email);
        if (!foundUser) {
          loginError.textContent = "No account found.";
          return;
        }
        if (foundUser.password !== password) {
          loginError.textContent = "Incorrect password.";
          return;
        }
        if (foundUser.role !== role) {
          loginError.textContent = "Incorrect role selected.";
          return;
        }
        setupUIForRole(role);
        showView("main-app-view");
      });

      logoutButton.addEventListener("click", () => {
        currentUserRole = null;
        currentPatientId = null;
        showView("login-view");
        loginFormContainer.classList.remove("hidden");
        loginError.textContent = "";
      });

      // --- MAIN EVENT HANDLER ---
      mainAppView.addEventListener("click", (e) => {
        const patientButton = e.target.closest(".view-patient-button");
        if (patientButton) {
          renderPatientView(patientButton.getAttribute("data-patient-id"));
          showView("patient-view", true);
          pageTitle.textContent = "Patient Details";
          return;
        }
        const backButton = e.target.closest(".back-to-dashboard");
        if (backButton) {
          currentPatientId = null;
          renderBedDashboard();
          showView("dashboard-view", true);
          pageTitle.textContent = "Bed Management";
          return;
        }
        const bedButton = e.target.closest(".bed-action-button");
        if (bedButton) {
          const action = bedButton.dataset.action,
            bedId = bedButton.dataset.bedId,
            bed = appState.beds.find((b) => b.id === bedId);
          if (!bed) return;
          if (action === "Discharge") {
            delete appState.patients[bed.patientId];
            bed.status = "PENDING_CLEANING";
            bed.patientId = null;
          } else if (action === "Admit") {
            currentBedToAdmit = bed.id;
            admitPatientModal.classList.remove("hidden");
          } else if (action === "Start-Cleaning") {
            bed.status = "UNDER_CLEANING";
          } else if (action === "Mark-Clean") {
            bed.status = "AVAILABLE";
          }
          renderBedDashboard();
          renderCleaningView();
          renderAdminView();
          return;
        }

        // ... (Rest of handlers for user edits, tasks, alerts remain similar but ensure functionality works)

        if (e.target.closest("#user-form-save-button")) {
          // ... existing logic ...
          const role = userFormRole.value,
            email = userFormEmail.value,
            password = userFormPassword.value;
          userFormStatus.textContent = "";
          userFormStatus.classList.remove("text-red-500", "text-green-500");
          if (!email) {
            userFormStatus.textContent = "Email required";
            userFormStatus.classList.add("text-red-500");
            return;
          }
          const isEdit = userFormEmail.readOnly;
          const existing = userDatabase.find((u) => u.email === email);
          if (isEdit) {
            existing.role = role;
            if (password) existing.password = password;
            userFormStatus.textContent = "Updated!";
            userFormStatus.classList.add("text-green-500");
          } else {
            if (!password) {
              userFormStatus.textContent = "Password req";
              userFormStatus.classList.add("text-red-500");
              return;
            }
            if (existing) {
              userFormStatus.textContent = "Exists";
              userFormStatus.classList.add("text-red-500");
              return;
            }
            userDatabase.push({ email, password, role });
            userFormStatus.textContent = "Created";
            userFormStatus.classList.add("text-green-500");
          }
          resetUserForm();
          renderAdminView();
          return;
        }

        if (e.target.closest("#user-form-cancel-button")) {
          resetUserForm();
          return;
        }

        const editUserBtn = e.target.closest(".edit-user-button");
        if (editUserBtn) {
          const u = userDatabase.find(
            (u) => u.email === editUserBtn.dataset.email
          );
          if (u) {
            userFormTitle.textContent = "Edit Staff";
            userFormSaveButton.textContent = "Update";
            userFormCancelButton.classList.remove("hidden");
            userFormEmail.value = u.email;
            userFormEmail.readOnly = true;
            userFormEmail.classList.add("bg-gray-100");
            userFormRole.value = u.role;
          }
          return;
        }

        const removeUserBtn = e.target.closest(".remove-user-button");
        if (removeUserBtn) {
          if (confirm("Remove user?")) {
            userDatabase = userDatabase.filter(
              (u) => u.email !== removeUserBtn.dataset.email
            );
            renderAdminView();
          }
          return;
        }

        if (e.target.closest("#add-patient-button")) {
          // logic for add patient
          const name = document.getElementById("add-patient-name").value,
            age = document.getElementById("add-patient-age").value,
            bedId = addPatientBedSelect.value;
          if (!name || !age || !bedId) {
            alert("Name, Age, Bed required");
            return;
          }
          const bed = appState.beds.find((b) => b.id === bedId);
          const pid = "p" + Date.now();
          appState.patients[pid] = {
            id: pid,
            name,
            bedId,
            age,
            diagnosis: document.getElementById("add-patient-diagnosis").value,
            medications: document.getElementById("add-patient-meds").value,
            priority: document.getElementById("add-patient-priority").value,
            vitalsLog: [],
          };
          bed.patientId = pid;
          bed.status = "OCCUPIED";
          renderAdminView();
          renderBedDashboard();
          document.getElementById("add-patient-name").value = "";
          return;
        }

        if (e.target.closest("#simulate-scan-button")) {
          renderPatientView("p1");
          showView("patient-view", true);
          pageTitle.textContent = "Patient Details";
          return;
        }

        if (e.target.closest("#add-task-button")) {
          const val = document.getElementById("new-task-input").value;
          if (val) {
            appState.nurseTasks.push({
              id: "nt" + Date.now(),
              patientId: currentPatientId,
              text: val,
              status: "PENDING",
            });
            renderPatientView(currentPatientId);
            renderNurseTasksView();
          }
          return;
        }

        // Vitals Save
        if (e.target.closest("#save-vitals-button")) {
          const bp = document.getElementById("vitals-bp").value;
          if (bp) {
            appState.patients[currentPatientId].vitalsLog.push({
              time: "Just now",
              bp: bp,
              pulse: document.getElementById("vitals-pulse").value,
              notes: document.getElementById("vitals-notes").value,
            });
            renderPatientView(currentPatientId);
          }
          return;
        }

        // Priority Update
        if (e.target.closest("#save-priority-button")) {
          const p = appState.patients[currentPatientId];
          p.priority = document.getElementById("patient-priority-select").value;
          renderPatientView(currentPatientId);
          return;
        }

        // Resolve Alert
        const resolveAlert = e.target.closest(".resolve-alert-button");
        if (resolveAlert) {
          appState.alerts = appState.alerts.filter(
            (a) => a.id !== resolveAlert.dataset.alertId
          );
          renderAlertsView();
          return;
        }
      });

      // Checkbox listener
      patientViewContainer.addEventListener("change", (e) => {
        if (
          e.target.classList.contains("task-checkbox") &&
          ["Nurse", "Doctor", "Admin"].includes(currentUserRole)
        ) {
          const t = appState.nurseTasks.find(
            (x) => x.id === e.target.dataset.taskId
          );
          if (t) {
            t.status = e.target.checked ? "COMPLETED" : "PENDING";
            renderPatientView(currentPatientId);
            renderNurseTasksView();
          }
        }
      });

      // Alert dropdown listener
      mainAppView.addEventListener("change", (e) => {
        if (
          e.target.classList.contains("update-alert-priority") &&
          ["Doctor", "Admin"].includes(currentUserRole)
        ) {
          const a = appState.alerts.find(
            (x) => x.id === e.target.dataset.alertId
          );
          if (a) {
            a.level = e.target.value;
            renderAlertsView();
          }
        }
      });

      // Modal listeners
      admitModalCancel.addEventListener("click", () =>
        admitPatientModal.classList.add("hidden")
      );
      admitModalSave.addEventListener("click", () => {
        const name = document.getElementById("admit-patient-name").value;
        if (name) {
          const pid = "p" + Date.now();
          appState.patients[pid] = {
            id: pid,
            name,
            bedId: currentBedToAdmit,
            age: document.getElementById("admit-patient-age").value,
            priority: document.getElementById("admit-patient-priority").value,
            diagnosis: document.getElementById("admit-patient-diagnosis").value,
            medications: document.getElementById("admit-patient-meds").value,
            vitalsLog: [],
          };
          const b = appState.beds.find((x) => x.id === currentBedToAdmit);
          b.status = "OCCUPIED";
          b.patientId = pid;
          admitPatientModal.classList.add("hidden");
          renderBedDashboard();
        }
      });

      function initializeApp() {
        populateRoleDropdowns();
        renderNavigation();
      }
      initializeApp();
    </script>
  </body>
</html>
